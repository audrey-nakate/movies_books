{% extends "base_generic.html" %}
{% load static %}
<!-- Home or Landing Page of the Website Displays the books available on the website -->

{% block content %}
    <a href="{% url 'create_chatroom' %}"><button id="createChatroom">Create Chatroom</button></a>
  <div class="chatroom-list">
    {% for chatroom in chatroom_list %}
        <div class="chatroom-details">
            <a href="{% url 'view_chatroom' chatroom_id=chatroom.id %}" class="join-link" data-chatroom-id="{{ chatroom.id }}" data-isMember="{{ chatroom.is_member }}">
                <img src="{{ chatroom.room_image.url }}" alt="{{ chatroom.name }}" class="book-cover">
            </a>
            <div class="book-info">
                <p class="chatroom-name">{{ chatroom.name }}</p>
                <p class="book-description">{{ chatroom.description }}</p> 
            </div>
        </div>
    {% empty %}
        <p>No Chatrooms Available.</p>
    {% endfor %}
  </div>

    <!-- script that allows users to join a chatroom that they left click on -->
    <script>
        // checking if the user is already part of the chatroom, and redirecting them to the chatroom if they are
        document.addEventListener("DOMContentLoaded", function() {
            var joinLinks = document.querySelectorAll('.join-link');
            joinLinks.forEach(function(link) {
                link.addEventListener('click', function(event) {
                    var isMember = this.dataset.ismember === 'true';
                    var roomId = this.dataset.chatroomId;

                    if (isMember) {
                        // If user is a member, allow the default action to proceed (no prompt)
                        return;
                    } else {
                        // If user is not a member, show the prompt
                        event.preventDefault(); // Prevent default action (following the link)
                        if (confirm("Do you want to join the chatroom?")) {
                            joinChatroom(roomId, this);
                        }
                    }
                });
            });
        });
    
        function joinChatroom(roomId, linkElement) {
            fetch(`/join_chatroom/${roomId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                credentials: 'same-origin',
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(data.message);
                    window.location.href = linkElement.href;
                } else if (data.status === 'already_member') {
                    alert(data.message);
                    window.location.href = data.redirect_url; // Redirect user to chatroom without further action
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            });
        }
    
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>        
{% endblock %}
